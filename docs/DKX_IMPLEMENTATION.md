# DKX 指标计算与交易时段处理实施文档

## 1. 概述
本文档详细说明了 Signal Monitor System 中 DKX (多空线) 指标的计算逻辑，特别是针对不同期货品种（纯日盘、夜盘至23:00、夜盘至01:00、夜盘至02:30）的复杂交易时段处理方案。

本实现旨在确保计算结果与同花顺 (THS) 等主流软件完全一致。

## 2. DKX 指标公式
DKX (多空线) 是一种中长线趋势指标，算法如下：

1.  **MID (中间价)**:
    $$ MID = \frac{3 \times Close + Low + Open + High}{6} $$
2.  **DKX (加权移动平均)**:
    对 MID 进行 20 周期加权移动平均，权重为 20, 19, ..., 1。
    $$ DKX = \frac{\sum_{i=0}^{19} (20-i) \times MID_{t-i}}{\sum_{j=1}^{20} j} $$
    其中分母 $\sum_{j=1}^{20} j = 210$。
3.  **MADKX (信号线)**:
    DKX 的 10 周期简单移动平均。
    $$ MADKX = MA(DKX, 10) $$

## 3. 交易时段处理与周期重采样 (Resampling)

### 3.1 核心挑战
不同期货品种的交易时间差异巨大，且存在跨日（夜盘）、午休中断等情况。简单的基于 K 线数量 (Count-based) 的重采样（如每 3 根 60 分钟 K 线合成 1 根 180 分钟 K 线）会导致以下错误：
*   **跨日错误**: 夜盘数据可能被错误地归并到前一交易日。
*   **午休错误**: 对于纯日盘品种（如碳酸锂 LC），上午交易 09:00-11:30 共 150 分钟。如果使用 60 分钟数据源，11:00-12:00 的 K 线实际上只包含 30 分钟交易（11:00-11:30），导致时间计算偏差。
*   **周期错位**: 180 分钟周期在不同品种上应该有固定的切分点（如 14:00），而非随意的数量累加。

### 3.2 解决方案：基于交易日与累计时间的聚合算法

我们在 `backend/services/backtest.py` 中实现了 `resample_data` 函数，采用以下策略：

#### A. 交易日识别 (Trading Day Shift)
为了正确处理夜盘（通常 21:00 开始），我们将时间戳向后偏移 3 小时来计算归属的交易日。
*   **逻辑**: `Trading Date = Date(Timestamp + 3 hours)`
*   **效果**:
    *   2023-10-27 14:00 -> 17:00 (属于 10-27)
    *   2023-10-27 21:00 -> 2023-10-28 00:00 (属于 10-28)
    *   2023-10-28 02:30 -> 05:30 (属于 10-28)
*   **目的**: 确保夜盘数据与次日日盘数据被归为同一个“逻辑交易日”，防止 K 线跨越交易日边界。

#### B. 基础数据源选择
*   **常规周期**: 使用 60 分钟数据。
*   **180 分钟周期**: **强制使用 30 分钟数据**作为基础源。
    *   **原因**: 纯日盘品种上午为 150 分钟 (5 个 30 分钟)。
    *   **切分逻辑**:
        *   Bar 1: 5 个 30 分钟 (09:00-11:30) = 150 分钟 (不足 180，继续累加)
        *   Bar 1 (续): +1 个 30 分钟 (13:30-14:00) = 180 分钟 -> **生成 K 线 (时间戳 14:00)**
        *   Bar 2: 剩余 30 分钟 (14:00-15:00) 共 2 个 30 分钟 = 60 分钟 (收盘强制结束)

#### C. 累计时间聚合 (Cumulative Time Aggregation)
算法维护一个“当前交易日内的累计交易分钟数”：
1.  对基础 K 线计算时长 (Duration)。
2.  在同一交易日内累加时长。
3.  `Group ID = floor((Cumulative Minutes - 0.1) / Target Period)`
4.  按 `[Trading Date, Group ID]` 进行 GroupBy 聚合 (Open First, High Max, Low Min, Close Last, Volume Sum)。

### 3.3 各类品种处理范例

#### 案例 1: 纯日盘 (碳酸锂 LC) - 180分钟周期
*   **交易时间**: 09:00-11:30, 13:30-15:00 (共 225 分钟)
*   **基础数据**: 30 分钟 K 线
*   **聚合结果**:
    1.  **09:00 - 14:00**: 包含 09:00-11:30 (150m) + 13:30-14:00 (30m) = 180m。生成第一根 K 线。
    2.  **14:00 - 15:00**: 包含 14:00-15:00 (60m)。生成第二根 K 线 (不足 180m，收盘结算)。
*   **同花顺一致性**: 也就是俗称的 "14:00 切分"，与同花顺算法一致。

#### 案例 2: 夜盘品种 (不锈钢 SS) - 180分钟周期
*   **交易时间**: 21:00-01:00 (夜), 09:00-10:15, 10:30-11:30, 13:30-15:00
*   **聚合结果**:
    1.  **21:00 - 24:00**: 累计 180m。生成第一根 K 线 (归属次日)。
    2.  **00:00 - 11:00**: 00:00-01:00 (60m) + 09:00-11:00 (120m) = 180m。生成第二根 K 线。
    *注意：中间包含 10:15-10:30 的小节休息，因使用 30 分钟数据源，实际上 10:00-10:30 的 K 线跨越了休息时间，但在聚合计算中仍记为 30 分钟时长，逻辑正确。*

## 4. 代码结构说明

*   **`backend/services/indicators.py`**:
    *   `calculate_dkx(df)`: 纯数学计算，输入为清洗好的 DataFrame。
    *   `check_dkx_signal(df)`: 信号检测 (金叉/死叉)。

*   **`backend/services/backtest.py`**:
    *   `resample_data(df, period)`: 核心重采样逻辑。包含交易日偏移和累计时间计算。
    *   `run_backtest(...)`: 主入口，负责获取数据并在需要时调用重采样。

*   **`backend/scripts/diagnose_dkx_logic.py`**:
    *   验证脚本，用于生成模拟数据并测试重采样逻辑的正确性。

## 5. 验证机制
已建立自动化验证脚本 `diagnose_dkx_logic.py`，可模拟生成不同品种的分钟级数据，并验证重采样后的 K 线时间戳和数量是否符合预期。

详细测试报告请参阅 `docs/DKX_VERIFICATION_REPORT.md`。
